name: Apply all security recommendations using Ansible Job Template
on:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  ApplyAnsibleFlows:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger compliance Job on Automation Controller
        run: |
          ANSIBLE_CONTROLLER_URL="https://electric-hermit-remarkably.ngrok-free.app"
          RESPONSE=$(curl -X POST -s -k \
          -H "Authorization: Bearer ${{ secrets.ANSIBLE_TOKEN }}" \
          -A "nonstandardUA" \
          "$ANSIBLE_CONTROLLER_URL/api/v2/job_templates/Autocompliance++Default/launch/")
          JOB_ID=$(echo $RESPONSE | jq -r '.job')
          echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV
          echo "ANSIBLE_CONTROLLER_URL=$ANSIBLE_CONTROLLER_URL" >> $GITHUB_ENV
          echo El job id es $JOB_ID

      - name: Obt√©n el job ID y hazle polling hasta que termine
        run: |
          JOB_STATUS="new"
          while [[ "$JOB_STATUS" == "new" || "$JOB_STATUS" == "pending" || "$JOB_STATUS" == "running" ]]; do
            sleep 10  # Poll every 30 seconds; adjust as necessary
            RESPONSE=$(curl -s -X GET "$ANSIBLE_CONTROLLER_URL/api/v2/jobs/$JOB_ID/" -H "Authorization: Bearer ${{ secrets.ANSIBLE_TOKEN }}")
            JOB_STATUS=$(echo $RESPONSE | jq -r '.status')
            echo "Job status: $JOB_STATUS"
          done
          if [[ "$JOB_STATUS" == "successful" ]]; then
            echo "Job completed successfully."
            exit 0
          else
            echo "Job failed with status $JOB_STATUS."
            ################ if job failed overall, report PLAY RECAP section===
            # Get job stdout
            RESPONSE=$(curl -s -X GET "$ANSIBLE_CONTROLLER_URL/api/v2/jobs/$JOB_ID/stdout?format=txt_download" -H "Authorization: Bearer ${{ secrets.ANSIBLE_TOKEN }}")
            # Print host summary from STDOUT
            echo "Results, please examine failed hosts manually:"
            echo "$RESPONSE" | awk '/PLAY RECAP/{flag=1} flag' | awk '{print $1}'
            exit 1
          fi
